<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üîÅ ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <div class="container">
    <h1>üîÅ ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>

    <button id="scan-btn">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
    <div id="reader" style="width:100%; max-width:400px; margin-top:1rem; display:none;"></div>

    <div id="item-details" style="margin-top: 1.5rem; display:none;">
      <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</strong> <span id="item-id"></span></p>
      <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</strong> <span id="item-name"></span></p>
      <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°:</strong> <span id="borrower"></span></p>
      <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°:</strong> <span id="date"></span></p>
      <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏∑‡∏°:</strong> <span id="time"></span></p>

      <button id="confirm-return" style="margin-top: 1rem;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    </div>

    <div id="status-message" style="margin-top: 1.5rem;"></div>

    <script>
      const GOOGLE_SCRIPT_URL = 'YOUR_GOOGLE_SCRIPT_URL'; // ‚Üê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

      const scanBtn = document.getElementById('scan-btn');
      const readerDiv = document.getElementById('reader');
      const itemDetails = document.getElementById('item-details');
      const statusMsg = document.getElementById('status-message');

      const idSpan = document.getElementById('item-id');
      const nameSpan = document.getElementById('item-name');
      const borrowerSpan = document.getElementById('borrower');
      const dateSpan = document.getElementById('date');
      const timeSpan = document.getElementById('time');

      const mapItemName = (id) => {
        if (id.startsWith('speaker')) return '‡∏•‡∏≥‡πÇ‡∏û‡∏á';
        if (id.startsWith('pointer')) return '‡∏û‡∏≠‡∏¢‡∏ô‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå';
        if (id.startsWith('plug')) return '‡∏õ‡∏•‡∏±‡πä‡∏Å‡πÑ‡∏ü';
        return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
      };

      let matchedRow = null;

      scanBtn.addEventListener('click', async () => {
        readerDiv.style.display = 'block';

        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          async (decodedText) => {
            html5QrCode.stop();
            readerDiv.innerHTML = '';

            const itemId = decodedText.trim();
            const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=read`);
            const data = await res.json();

            const match = data
              .map((row, i) => ({ ...row, rowIndex: i + 2 }))
              .find(row => row.itemId === itemId && row.returned !== 'TRUE');

            if (match) {
              matchedRow = match;
              idSpan.textContent = match.itemId;
              nameSpan.textContent = mapItemName(match.itemId);
              borrowerSpan.textContent = match.borrower;
              dateSpan.textContent = match.date;
              timeSpan.textContent = match.time;
              itemDetails.style.display = 'block';
              statusMsg.textContent = '';
            } else {
              statusMsg.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ';
            }
          },
          (err) => {}
        );
      });

      document.getElementById('confirm-return').addEventListener('click', async () => {
        if (!matchedRow) return;
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'returnItem',
            rowIndex: matchedRow.rowIndex,
          }),
        });

        statusMsg.textContent = '‚úÖ ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!';
        itemDetails.style.display = 'none';
      });
    </script>
  </div>
</body>
</html>
